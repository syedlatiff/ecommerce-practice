<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>E-Commerce Portal</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3144/3144456.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* All your existing CSS remains exactly the same */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      :root {
        --bg-color: #f4f4f4;
        --text-color: #000;
        --container-bg: #fff;
        --error-color: #ff4444;
        --success-color: #00C851;
        --primary-color: #4CAF50;
        --secondary-color: #45a049;
        --activity-bg: #f9f9f9;
        --activity-text: #333;
        --logo-filter: none;
        --button-text: #000;
        --input-bg: #fff;
        --input-text: #000;
        --select-bg: #fff;
        --select-text: #000;
        --cart-count-bg: #4CAF50;
        --cart-count-text: #000;
        --continue-shopping-bg: #4CAF50;
        --continue-shopping-text: #000;
        --notification-bg: #4CAF50;
        --notification-text: #000;
        --back-button-bg: #4CAF50;
      }

      body.dark-mode {
        --bg-color: #121212;
        --text-color: #fff;
        --container-bg: #1e1e1e;
        --error-color: #ff6b6b;
        --activity-bg: #2a2a2a;
        --activity-text: #fff;
        --logo-filter: invert(1) brightness(2);
        --button-text: #fff;
        --input-bg: #1e1e1e;
        --input-text: #fff;
        --select-bg: #1e1e1e;
        --select-text: #fff;
        --cart-count-bg: #4CAF50;
        --cart-count-text: #fff;
        --continue-shopping-bg: #4CAF50;
        --continue-shopping-text: #fff;
        --notification-bg: #4CAF50;
        --notification-text: #fff;
        --back-button-bg: #4CAF50;
      }

      body.dark-mode .fa-shopping-cart {
        color: white !important;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: all 0.3s ease;
      }

      .container {
        max-width: 800px;
        width: 100%;
        padding: 25px;
        background: var(--container-bg);
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        margin: 20px auto;
        position: relative;
      }

      h2 {
        text-align: center;
        margin-bottom: 20px;
        color: var(--primary-color);
      }

      .form-group {
        margin-bottom: 20px;
        position: relative;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
      }

      input[type="text"],
      input[type="password"],
      input[type="email"],
      input[type="tel"],
      input[type="number"],
      input[type="text"]:focus,
      input[type="password"]:focus,
      input[type="email"]:focus,
      input[type="tel"]:focus,
      input[type="number"]:focus {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--input-text);
        font-size: 16px;
        transition: all 0.3s;
        height: 48px;
        box-sizing: border-box;
      }

      .password-container {
        position: relative;
      }

      #loginForm {
        max-width: 400px;
        margin: 0 auto;
      }

      input[type="password"] {
        padding-right: 40px;
      }

      .toggle-password {
        position: absolute;
        right: 10px;
        top: 70%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin: 0;
      }

      .toggle-password i {
        font-size: 18px;
        color: #777;
      }

      .toggle-password:hover {
        transform: translateY(-50%) !important;
      }

      input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
      }

      button,
      .btn {
        padding: 12px 20px;
        background: var(--primary-color);
        color: var(--button-text);
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        display: inline-block;
        text-decoration: none;
        font-weight: bold;
      }

      button:hover,
      .btn:hover {
        background: var(--secondary-color);
        transform: translateY(-2px);
      }

      #dashboard,
      #products-page,
      #checkout-page,
      #order-processing-page,
      #order-complete-page {
        display: none;
      }

      .error-message {
        color: var(--error-color);
        font-size: 14px;
        margin-top: 5px;
        display: none;
        text-align: center;
        font-weight: bold;
      }

      #lock-message {
        text-align: center;
        color: var(--error-color);
        margin-bottom: 15px;
        font-weight: bold;
        display: none;
      }

      .success-message {
        color: var(--success-color);
        margin: 15px 0;
        opacity: 1;
        transition: opacity 0.5s ease;
      }

      .success-message.fade-out {
        opacity: 0;
      }

      .icon {
        display: block;
        margin: 0 auto 15px auto;
        width: 80px;
      }

      .logo {
        display: block;
        width: 150px;
        margin: 0 auto 20px auto;
        filter: var(--logo-filter);
        transition: filter 0.3s ease;
      }

      .theme-toggle {
        position: fixed;
        top: 15px;
        right: 15px;
        cursor: pointer;
        font-size: 18px;
        background: #ddd;
        padding: 5px 10px;
        border-radius: 20px;
        z-index: 100;
      }

      body.dark-mode .theme-toggle {
        background: #333;
        color: white;
      }

      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .product-card {
        background: var(--container-bg);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }

      .product-card:hover {
        transform: translateY(-5px);
      }

      .product-image {
        width: 100%;
        height: 160px;
        object-fit: cover;
      }

      .product-info {
        padding: 15px;
      }

      .product-title {
        font-weight: bold;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .product-price {
        color: var(--primary-color);
        font-weight: bold;
        margin: 10px 0;
      }

      .product-actions {
        display: flex;
        justify-content: space-between;
      }

      .cart-items {
        margin: 20px 0;
      }

      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        gap: 10px;
      }

      .cart-item-info {
        display: flex;
        align-items: center;
        flex: 1;
        min-width: 0;
      }

      .cart-item-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        margin-right: 15px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .cart-item-details {
        flex: 1;
        min-width: 0;
        max-width: 100%;
        /* üõ° ensure name doesn't overflow */
        display: flex;
        flex-direction: column;
      }

      .cart-item-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 160px;
        /* üëà adjust based on available space */
      }

      .cart-item-quantity {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        margin: 0 10px;
        justify-content: center;
        width: 120px;
      }

      .quantity-btn {
        width: 32px;
        height: 32px;
        background: var(--primary-color);
        /* Green background */
        color: var(--button-text);
        /* Black in light, white in dark */
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .quantity-btn:hover {
        background: var(--secondary-color);
        /* Slightly darker green on hover */
        transform: translateY(-1px);
      }

      .quantity-input {
        width: 60px;
        /* try increasing */
        font-size: 16px;
        /* make sure text is visible */
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 6px;
        background-color: var(--input-bg);
        color: var(--input-text);
		margin: 0 8px; /* ‚¨ÖÔ∏è Add this line for spacing on left and right */
      }

      .cart-item-quantity input {
        flex-shrink: 0;
      }

      .quantity-input::-webkit-outer-spin-button,
      .quantity-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .cart-item-price {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-shrink: 0;
        min-width: 120px;
        justify-content: flex-end;
      }

      .cart-item-price-value {
        min-width: 80px;
        text-align: right;
      }

      .remove-item {
        color: var(--error-color);
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        display: flex;
        align-items: center;
      }

      .remove-item:hover {
        color: #ff0000;
      }

      .cart-summary {
        text-align: right;
        font-size: 16px;
        margin: 20px 0;
      }

      .cart-summary div {
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .cart-summary-label {
        text-align: left;
        padding-right: 15px;
      }

      .cart-summary-value {
        min-width: 80px;
        text-align: right;
      }

      .cart-total {
        font-weight: bold;
        font-size: 18px;
        border-top: 1px solid #ddd;
        padding-top: 8px;
        margin-top: 8px;
      }

      .checkout-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .checkout-section {
        width: 100%;
      }

      .checkout-summary {
        background: var(--activity-bg);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        width: 100%;
      }


      .card-type-select {
        padding-right: 60px;
        width: 100%;
        padding: 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        appearance: none;
        background-color: var(--select-bg);
        color: var(--select-text);
        font-size: 16px;
      }


	.card-type-container {
	  position: relative;
	  min-height: 62px; /* Base height without error */
	}

	.card-type-logo {
	  position: absolute;
	  top: 41px; /* Fixed pixel position from top */
	  right: 15px;
	  width: 30px;
	  height: 20px;
	  object-fit: contain;
	  display: none;
	  pointer-events: none;
	  transition: top 0.2s ease;
	}

	/* When error is present */
	.card-type-container.has-error {
	  min-height: 82px; /* Increased height for error message */
	}

	.card-type-container.has-error .card-type-logo {
	  top: 41px; /* Adjusted position when error visible */
	}
	
      .complete-purchase-btn {
        display: block;
        margin: 20px auto;
        width: 200px;
      }

      .checkout-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .back-to-products-btn {
        padding: 8px 15px;
        background: var(--back-button-bg);
        color: var(--button-text);
        margin-left: auto;
      }

      .processing-animation {
        text-align: center;
        padding: 40px 0;
      }

      .spinner {
        border: 5px solid rgba(0, 0, 0, 0.1);
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .activity-container {
        background: var(--activity-bg);
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
        color: var(--activity-text);
      }

      .cart-count {
        background: var(--cart-count-bg);
        color: var(--cart-count-text);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
      }

      .same-billing-container {
        margin: 15px 0;
        display: flex;
        align-items: center;
      }

      .same-billing-container input {
        margin-right: 10px;
      }

      @media (max-width: 768px) {
        .products-grid {
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }

        .cart-item {
          flex-wrap: wrap;
        }

        .cart-item-price {
          margin-left: auto;
        }
      }

      body:not(.dark-mode) .card-type-logo.light-logo {
        display: inline;
      }

      body:not(.dark-mode) .card-type-logo.dark-logo {
        display: none;
      }

      body.dark-mode .card-type-logo.light-logo {
        display: none;
      }

      body.dark-mode .card-type-logo.dark-logo {
        display: inline;
      }

      #cardUsageChart {
        width: 100% !important;
        height: 300px !important;
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div class="theme-toggle" onclick="toggleTheme()">üåì Theme</div>
    <!-- Logout Message -->
    <div id="logout-message" class="container" style="text-align:center; display:none;">
      <img src="https://cdn-icons-png.flaticon.com/512/1828/1828490.png" class="icon" alt="logout icon">
      <p class="success-message">‚úÖ Successfully logged out</p>
    </div>
    <!-- Login Form -->
    <div id="login-container" class="container">
      <img src="https://cdn-icons-png.flaticon.com/512/3144/3144456.png" class="logo" alt="Brand Logo">
      <h2>Welcome to Our Store</h2>
      <div id="lock-message">Account Locked. Contact Administrator.</div>
      <div id="retry-warning" class="error-message" style="display: none; color: #ff9800;"></div>
      <div id="invalid-credentials" class="error-message">Invalid Logins. Please try again.</div>
      <div id="invalid-password" class="error-message" style="display: none;">Invalid Password. Please try again.</div>
      <div id="invalid-username" class="error-message" style="display: none;">Invalid Username. Please try again.</div>
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" name="username" placeholder="Enter your username" required>
          <div id="username-error" class="error-message"></div>
        </div>
        <div class="form-group password-container">
          <label for="password">Password:</label>
          <input type="password" id="password" name="password" placeholder="Enter your password" required>
          <button type="button" class="toggle-password" onclick="togglePassword()">
            <i class="fas fa-eye" id="toggleIcon"></i>
          </button>
          <div id="password-error" class="error-message"></div>
        </div>
        <button type="submit" id="loginBtn">Login</button>
      </form>
    </div>
    <!-- Dashboard -->
    <div id="dashboard" class="container">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Welcome Back!</h2>
        <div style="display: flex; align-items: center; gap: 15px;">
          <span id="cart-count" class="cart-count">0</span>
          <button onclick="viewCart()" style="padding: 8px 15px; color: inherit;">
            <i class="fas fa-shopping-cart"></i>
          </button>
        </div>
      </div>
      <p class="success-message" id="login-success">You have successfully logged in.</p>
      <div style="display: flex; justify-content: center; gap: 20px; margin: 30px 0; flex-wrap: wrap;">
        <button onclick="showProducts()" class="btn">
          <i class="fas fa-store" style="margin-right: 8px;"></i> Browse Products </button>
        <button id="viewAnalyticsBtn" class="btn">
          <i class="fas fa-chart-bar" style="margin-right: 8px;"></i> View Analytics </button>
        <button id="logoutBtn" class="btn">
          <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i> Logout </button>
      </div>
      <div style="margin-top: 40px; text-align: center;">
        <h3>Your Recent Activity</h3>
        <div class="activity-container" id="recent-activity">
          <p>You have no recent activity</p>
          <p style="font-size: 14px; color: #777; margin-top: 10px;">Start shopping to see your activity here</p>
        </div>
      </div>
    </div>
    <div id="analytics-section" class="container" style="display:none;">
      <h2 style="text-align: center;">üìä Payment Method Analytics</h2>
      <canvas id="cardUsageChart" width="400" height="200"></canvas>
      <button onclick="backToDashboard()" class="btn" style="margin-top: 20px;">
        <i class="fas fa-arrow-left"></i> Back to Dashboard </button>
    </div>
    <!-- Products Page -->
    <div id="products-page" class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Our Products</h2>
        <div style="display: flex; align-items: center; gap: 15px;">
          <span id="cart-count-products" class="cart-count">0</span>
          <button onclick="viewCart()" style="padding: 8px 15px; color: inherit;">
            <i class="fas fa-shopping-cart"></i> View Cart </button>
          <button onclick="backToDashboard()" class="btn" style="padding: 8px 15px;">
            <i class="fas fa-arrow-left"></i> Back </button>
        </div>
      </div>
      <div class="products-grid" id="products-container">
        <!-- Products will be loaded here by JavaScript -->
      </div>
    </div>
    <!-- Checkout Page -->
    <div id="checkout-page" class="container">
      <div class="checkout-header">
        <h2>Checkout</h2>
        <button onclick="backToProducts()" class="back-to-products-btn">
          <i class="fas fa-arrow-left"></i> Continue Shopping </button>
      </div>
      <div class="checkout-form">
        <div class="checkout-section">
          <div class="checkout-summary">
            <h3>Order Summary</h3>
            <div id="checkout-items">
              <!-- Cart items will be loaded here -->
            </div>
            <div class="cart-summary">
              <div>
                <span class="cart-summary-label">Subtotal:</span>
                <span class="cart-summary-value">$ <span id="checkout-subtotal">0.00</span>
                </span>
              </div>
              <div>
                <span class="cart-summary-label">Shipping:</span>
                <span class="cart-summary-value">$ <span id="checkout-shipping">0.00</span>
                </span>
              </div>
              <div>
                <span class="cart-summary-label">Tax (13% HST):</span>
                <span class="cart-summary-value">$ <span id="checkout-tax">0.00</span>
                </span>
              </div>
              <div class="cart-total">
                <span class="cart-summary-label">Total:</span>
                <span class="cart-summary-value">$ <span id="checkout-total">0.00</span>
                </span>
              </div>
            </div>
          </div>
        </div>
        <!-- Rest of your checkout form remains the same -->
        <div class="checkout-section">
          <h3>Shipping Information</h3>
          <div class="form-group">
            <label for="full-name">Full Name</label>
            <input type="text" id="full-name" required>
            <div id="full-name-error" class="error-message" style="display: none;">Please enter your full name</div>
          </div>
          <div class="form-group">
            <label for="address">Address</label>
            <input type="text" id="address" required>
            <div id="address-error" class="error-message" style="display: none;">Please enter your address</div>
          </div>
          <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" required>
            <div id="city-error" class="error-message" style="display: none;">Please enter your city</div>
          </div>
          <div class="form-group">
            <label for="zip">Postal Code</label>
            <input type="text" id="zip" required>
            <div id="zip-error" class="error-message" style="display: none;">Please enter your postal code</div>
          </div>
          <div class="form-group">
            <label for="country">Country</label>
            <select id="country" class="card-type-select">
              <option value="US">United States</option>
              <option value="UK">United Kingdom</option>
              <option value="CA">Canada</option>
              <option value="AU">Australia</option>
            </select>
          </div>
          <div class="same-billing-container">
            <input type="checkbox" id="same-billing" checked>
            <label for="same-billing">Billing address same as shipping address</label>
          </div>
          <div id="billing-address-section" style="display: none;">
            <h3>Billing Information</h3>
            <div class="form-group">
              <label for="billing-full-name">Full Name</label>
              <input type="text" id="billing-full-name">
            </div>
            <div class="form-group">
              <label for="billing-address">Address</label>
              <input type="text" id="billing-address">
            </div>
            <div class="form-group">
              <label for="billing-city">City</label>
              <input type="text" id="billing-city">
            </div>
            <div class="form-group">
              <label for="billing-zip">Postal Code</label>
              <input type="text" id="billing-zip">
              <div id="billing-zip-error" class="error-message" style="display: none;">Please enter your postal code</div>
            </div>
            <div class="form-group">
              <label for="billing-country">Country</label>
              <select id="billing-country" class="card-type-select">
                <option value="US">United States</option>
                <option value="UK">United Kingdom</option>
                <option value="CA">Canada</option>
                <option value="AU">Australia</option>
              </select>
            </div>
          </div>
        </div>
        <div class="checkout-section">
          <h3>Payment Information</h3>
          <div class="form-group card-type-container">
            <label for="card-type">Card Type</label>
            <select id="card-type" class="card-type-select" required>
              <option value="">Select Card Type</option>
              <option value="visa">Visa</option>
              <option value="mastercard">MasterCard</option>
              <option value="amex">American Express</option>
              <option value="discover">Discover</option>
            </select>
            <!-- Visa Logos -->
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/2560px-Visa_Inc._logo.svg.png" class="card-type-logo visa-logo light-logo" id="visa-logo-light" alt="Visa">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/2560px-Visa_Inc._logo.svg.png" class="card-type-logo visa-logo dark-logo" id="visa-logo-dark" alt="Visa">
            <!-- MasterCard Logos -->
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/1280px-Mastercard-logo.svg.png" class="card-type-logo mastercard-logo light-logo" id="mastercard-logo-light" alt="MasterCard">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/1280px-Mastercard-logo.svg.png" class="card-type-logo mastercard-logo dark-logo" id="mastercard-logo-dark" alt="MasterCard">
            <!-- Amex Logos -->
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/American_Express_logo.svg/1200px-American_Express_logo.svg.png" class="card-type-logo amex-logo light-logo" id="amex-logo-light" alt="American Express">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/American_Express_logo.svg/1200px-American_Express_logo.svg.png" class="card-type-logo amex-logo dark-logo" id="amex-logo-dark" alt="American Express">
            <!-- Discover Logos -->
            <img src="https://1000logos.net/wp-content/uploads/2021/05/Discover-logo.png" class="card-type-logo discover-logo light-logo" id="discover-logo-light" alt="Discover">
            <img src="https://1000logos.net/wp-content/uploads/2021/05/Discover-logo.png" class="card-type-logo discover-logo dark-logo" id="discover-logo-dark" alt="Discover">
            <div id="card-type-error" class="error-message" style="display: none;">Please select a card type</div>
          </div>
          <div class="form-group">
            <label for="card-name">Name on Card</label>
            <input type="text" id="card-name" required>
            <div id="card-name-error" class="error-message" style="display: none;">Please enter the name on card</div>
          </div>
          <div class="form-group">
            <label for="card-number">Card Number</label>
            <input type="text" id="card-number" placeholder="1234 5678 9012 3456" required>
            <div id="card-number-error" class="error-message" style="display: none;">Please enter a valid card number</div>
          </div>
          <div class="form-group">
            <label for="expiry">Expiry Date</label>
            <input type="text" id="expiry" placeholder="MM/YY" required>
            <div id="expiry-error" class="error-message" style="display: none;">Please enter a valid expiry date (MM/YY)</div>
          </div>
          <div class="form-group">
            <label for="cvv">CVV</label>
            <input type="text" id="cvv" placeholder="123" required>
            <div id="cvv-error" class="error-message" style="display: none;">Please enter a valid CVV (3-4 digits)</div>
          </div>
        </div>
        <button onclick="completePurchase()" class="complete-purchase-btn"> Complete Purchase </button>
      </div>
    </div>
    <!-- Order Processing Page -->
    <div id="order-processing-page" class="container" style="display: none; text-align: center;">
      <div class="processing-animation">
        <div class="spinner"></div>
        <p>Processing your order...</p>
      </div>
    </div>
    <!-- Order Complete Page -->
    <div id="order-complete-page" class="container" style="display: none; text-align: center;">
      <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" class="icon" alt="Success icon">
      <h2>Order Successfully Completed!</h2>
      <p>Thank you for your purchase.</p>
      <button onclick="backToProducts()" class="btn" style="margin-top: 20px;">
        <i class="fas fa-arrow-left"></i> Back to Products </button>
    </div>
    <!-- Order Failed Page -->
    <div id="order-failed-page" class="container" style="display: none; text-align: center;">
      <img src="https://cdn-icons-png.flaticon.com/512/753/753345.png" class="icon" alt="Error icon">
      <h2 style="color: var(--error-color);">Order Failed!</h2>
      <p>We're sorry, your payment could not be completed. Possible reasons include:</p>
	  <ul id="payment-failure-reason" style="text-align: left; margin: 10px auto; max-width: 500px; color: var(--error-color); font-weight: bold;">
	    <!-- Dynamic reason will be inserted here -->
	  </ul>
      <p id="payment-retry-warning" style="display:none; color: #c62828; font-weight: bold; margin-top: 15px;"></p>
      <!--button id="retryPaymentBtn" onclick="retryPayment()" class="btn" style="margin-top: 20px; margin-right: 10px;"> üîÅ Retry Payment </button-->
	  <button id="retryPaymentBtn" onclick="retryPayment()" class="btn" style="margin-top: 20px; margin-right: 10px;">
		<span style="line-height: 1;">üîÅ</span> Retry Payment
	  </button>
	  <button onclick="backToProducts()" class="btn" style="margin-top: 20px;">
       <i class="fas fa-arrow-left"></i> Back to Products </button>
    </div>
    <script>
      // DOM Elements
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const loginForm = document.getElementById("loginForm");
      const usernameError = document.getElementById("username-error");
      const invalidCredentials = document.getElementById("invalid-credentials");
      const invalidPassword = document.getElementById("invalid-password");
      const invalidUsername = document.getElementById("invalid-username");
      const lockMessage = document.getElementById("lock-message");
      const toggleIcon = document.getElementById("toggleIcon");
      const loginSuccess = document.getElementById("login-success");
      const productsContainer = document.getElementById("products-container");
      const checkoutItems = document.getElementById("checkout-items");
      const cardTypeSelect = document.getElementById("card-type");
      const recentActivity = document.getElementById("recent-activity");
      const sameBillingCheckbox = document.getElementById("same-billing");
      const billingAddressSection = document.getElementById("billing-address-section");
      const expiryInput = document.getElementById("expiry");
      let paymentFailedAttempts = 0;
      const maxPaymentRetries = 3;
	  const cardFailureReasons = {
	  "4111111111111119": "Invalid card",      // Visa
	  "4000000000009995": "Insufficient funds",// Visa
	  "4000000000000002": "Card not supported",// Visa
	  "5555555555558726": "Invalid card",      // MasterCard
	  "376525000000010":  "Invalid card",      // Amex
	  "6011000000001010": "Invalid card"       // Discover
	  };


      function formatExpiryInput(event) {
        const input = event.target;
        const raw = input.value.replace(/\D/g, '');
        let newValue = raw.slice(0, 4); // Only allow 4 digits
        let cardUsageChartInstance = null;
        // Apply MM/YY format
        if (newValue.length > 2) {
          newValue = newValue.slice(0, 2) + '/' + newValue.slice(2);
        }
        // Save current cursor position
        let cursor = input.selectionStart;
        const prevLength = input.value.length;
        input.value = newValue;
        // Adjust cursor if slash is inserted or removed
        let nextLength = newValue.length;
        let offset = nextLength - prevLength;
        if (cursor === 3 && offset > 0) {
          cursor++;
        } else if (cursor === 3 && offset < 0) {
          cursor--;
        }
        setTimeout(() => {
          input.setSelectionRange(cursor, cursor);
        }, 0);
      }
      expiryInput.addEventListener('input', formatExpiryInput);
      // Block non-digits on input
      expiryInput.addEventListener('beforeinput', (e) => {
        const isDigit = /^\d$/.test(e.data);
        const isDelete = ['deleteContentBackward', 'deleteContentForward'].includes(e.inputType);
        if (!isDigit && !isDelete && e.inputType !== null) {
          e.preventDefault();
        }
      });
      // State variables
      let failedAttempts = 0;
      let accountLocked = false;
      let cart = [];
      // Constants
      const SHIPPING_COST = 10.00;
      const TAX_RATE = 0.13; // 13% HST in Ontario
      // Sample products data
      const products = [{
        id: 1,
        name: "Wireless Headphones with Extra Long Name to Test Layout",
        price: 99.99,
        image: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60"
      }, {
        id: 2,
        name: "Smart Watch",
        price: 199.99,
        image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60"
      }, {
        id: 3,
        name: "Bluetooth Speaker",
        price: 79.99,
        image: "https://images.unsplash.com/photo-1572569511254-d8f925fe2cbb?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60"
      }, {
        id: 4,
        name: "Laptop Backpack",
        price: 49.99,
        image: "https://images.unsplash.com/photo-1553062407-98eeb64c6a62?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60"
      }, {
        id: 5,
        name: "Wireless Mouse",
        price: 29.99,
        image: "https://images.unsplash.com/photo-1527814050087-3793815479db?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60"
      }, {
        id: 6,
        name: "External Hard Drive",
        price: 89.99,
        image: "https://images.unsplash.com/photo-1581349485608-9469926a8e5e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60"
      }];
      // Initialize - hide all pages except login
      function init() {
        const pages = ["login-container", "dashboard", "products-page", "checkout-page", "logout-message", "order-processing-page", "order-complete-page"];
        pages.forEach(page => {
          document.getElementById(page).style.display = page === "login-container" ? "block" : "none";
        });
        invalidCredentials.style.display = "none";
        invalidPassword.style.display = "none";
        invalidUsername.style.display = "none";
        lockMessage.style.display = "none";
        // Show all card logos initially (they'll be hidden by default in CSS)
        document.querySelectorAll('.card-type-logo').forEach(logo => {
          logo.style.display = 'none';
        });
        // Billing address toggle
        sameBillingCheckbox.addEventListener('change', function() {
          billingAddressSection.style.display = this.checked ? 'none' : 'block';
        });
        // Set shipping cost initially to 0 (will update when items are added)
        document.getElementById("checkout-shipping").textContent = "0.00";
        // Add event listeners for payment field formatting
        document.getElementById('card-number').addEventListener('input', function() {
          formatCardNumber(this);
        });
        expiryInput.addEventListener('keydown', function(e) {
          const isDelete = e.key === 'Delete';
          const isBackspace = e.key === 'Backspace';
          if (!isDelete && !isBackspace) return;
          e.preventDefault();
          let raw = this.value.replace(/\D/g, ''); // Remove all non-digits
          let cursor = this.selectionStart;
          // Determine position in raw value (without /)
          let rawPos = cursor > 2 ? cursor - 1 : cursor;
          if (isBackspace && rawPos > 0) {
            raw = raw.slice(0, rawPos - 1) + raw.slice(rawPos);
            rawPos--;
          } else if (isDelete && rawPos < raw.length) {
            raw = raw.slice(0, rawPos) + raw.slice(rawPos + 1);
          }
          // Re-format to MM/YY
          let formatted = raw;
          if (formatted.length >= 3) {
            formatted = formatted.slice(0, 2) + '/' + formatted.slice(2, 4);
          }
          this.value = formatted;
          // Set new cursor position
          let newCursor = rawPos >= 2 ? rawPos + 1 : rawPos;
          this.setSelectionRange(newCursor, newCursor);
        });
        document.getElementById('cvv').addEventListener('input', function() {
          formatCVV(this);
        });
      }
      init();
      // Payment validation functions
      function validateCardNumber(cardNumber) {
        // Basic validation - remove spaces and check length
        const cleaned = cardNumber.replace(/\s+/g, '');
        if (!/^\d+$/.test(cleaned)) return false;
        // Check length based on card type (basic validation)
        const cardType = document.getElementById('card-type').value;
        switch (cardType) {
          case 'visa':
            return /^4\d{12,15}$/.test(cleaned);
          case 'mastercard':
            return /^5[1-5]\d{14}$/.test(cleaned);
          case 'amex':
            return /^3[47]\d{13}$/.test(cleaned);
          case 'discover':
            return /^6(?:011|5\d{2})\d{12}$/.test(cleaned);
          default:
            return cleaned.length >= 13 && cleaned.length <= 19;
        }
      }

      function validateExpiryDate(expiry) {
        if (!/^\d{2}\/\d{2}$/.test(expiry)) {
          document.getElementById('expiry-error').textContent = 'Please enter valid expiry date (MM/YY)';
          return false;
        }
        const [month, year] = expiry.split('/').map(Number);
        const currentYear = new Date().getFullYear() % 100;
        const currentMonth = new Date().getMonth() + 1;
        if (month < 1 || month > 12) {
          document.getElementById('expiry-error').textContent = 'Invalid Month';
          return false;
        }
        if (year < currentYear || (year === currentYear && month < currentMonth)) {
          document.getElementById('expiry-error').textContent = 'Invalid Year';
          return false;
        }
        return true;
      }

      function validateCVV(cvv) {
        const cardType = document.getElementById('card-type').value;
        if (cardType === 'amex') {
          if (!/^\d{4}$/.test(cvv)) {
            document.getElementById('cvv-error').textContent = 'Invalid CVV (4 digits required for Amex)';
            return false;
          }
        } else {
          if (!/^\d{3}$/.test(cvv)) {
            document.getElementById('cvv-error').textContent = 'Invalid CVV (3 digits required)';
            return false;
          }
        }
        return true;
      }

      function validatePostalCode(postalCode, country) {
        const patterns = {
          'US': /^\d{5}(-\d{4})?$/, // US ZIP code
          'UK': /^[A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2}$/i, // UK postcode
          'CA': /^[A-Z]\d[A-Z] ?\d[A-Z]\d$/i, // Canadian postal code
          'AU': /^\d{4}$/ // Australian postcode
        };
        if (!patterns[country]) return true; // No pattern for this country
        return patterns[country].test(postalCode);
      }
	  
      function validatePaymentForm() {
        let isValid = true;
		const cardTypeContainer = document.querySelector('.card-type-container');
        // Card type validation
        const cardType = document.getElementById('card-type').value;
        if (!cardType) {
          document.getElementById('card-type-error').style.display = 'block';
		  cardTypeContainer.classList.add('has-error');
          isValid = false;
        } else {
          document.getElementById('card-type-error').style.display = 'none';
		  cardTypeContainer.classList.remove('has-error');
        }
		
        // Card name validation
        const cardName = document.getElementById('card-name').value.trim();
        if (!cardName) {
          document.getElementById('card-name-error').style.display = 'block';
          isValid = false;
        } else {
          document.getElementById('card-name-error').style.display = 'none';
        }
        // Card number validation
        const cardNumber = document.getElementById('card-number').value.trim();
        if (!validateCardNumber(cardNumber)) {
          document.getElementById('card-number-error').textContent = 'Please enter a valid card number';
          document.getElementById('card-number-error').style.display = 'block';
          isValid = false;
        } else {
          document.getElementById('card-number-error').style.display = 'none';
        }
        // Expiry date validation
        const expiry = document.getElementById('expiry').value.trim();
        if (!validateExpiryDate(expiry)) {
          document.getElementById('expiry-error').style.display = 'block';
          isValid = false;
        } else {
          document.getElementById('expiry-error').style.display = 'none';
        }
        // CVV validation
        const cvv = document.getElementById('cvv').value.trim();
        if (!validateCVV(cvv)) {
          document.getElementById('cvv-error').style.display = 'block';
          isValid = false;
        } else {
          document.getElementById('cvv-error').style.display = 'none';
        }
        return isValid;
      }

      function formatCardNumber(input) {
        // Remove all non-digit characters
        let value = input.value.replace(/\D/g, '');
        // Add spaces every 4 digits
        value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
        // Update the input value
        input.value = value;
      }

      function formatCVV(input) {
        input.value = input.value.replace(/\D/g, '');
      }
      // Form submission
      loginForm.addEventListener("submit", function(e) {
        e.preventDefault();
        if (accountLocked) return;
        const username = usernameInput.value;
        const password = passwordInput.value;
        // Reset error messages
        invalidCredentials.style.display = "none";
        invalidPassword.style.display = "none";
        invalidUsername.style.display = "none";
        usernameError.style.display = "none";
        // Check for empty fields
        if (!username && !password) {
          invalidCredentials.textContent = "Please enter both username and password";
          invalidCredentials.style.display = "block";
          setTimeout(() => {
            invalidCredentials.style.display = "none";
          }, 3000);
          return;
        } else if (!username) {
          usernameError.textContent = "Please enter your username";
          usernameError.style.display = "block";
          setTimeout(() => {
            usernameError.style.display = "none";
          }, 3000);
          return;
        } else if (!password) {
          document.getElementById("password-error").textContent = "Please enter your password";
          document.getElementById("password-error").style.display = "block";
          setTimeout(() => {
            document.getElementById("password-error").style.display = "none";
          }, 3000);
          return;
        }
        if (username === "invalid@example.com" && password === "wrongpass") {
          failedAttempts++;
          const retryWarning = document.getElementById("retry-warning");
          if (failedAttempts >= 3) {
            accountLocked = true;
            lockMessage.style.display = "block";
            // ‚úÖ Ensure retry warning is hidden when locked
            retryWarning.style.display = "none";
            setTimeout(() => {
              lockMessage.style.display = "none";
              failedAttempts = 0;
              accountLocked = false;
            }, 5000);
          } else {
            // Show invalid credentials
            invalidCredentials.textContent = "Invalid Logins. Please try again.";
            invalidCredentials.style.display = "block";
            // Show retry warning
            const remainingAttempts = 3 - failedAttempts;
            retryWarning.textContent = `‚ö†Ô∏è You have ${remainingAttempts} attempt${remainingAttempts === 1 ? '' : 's'} left before your account is temporarily locked.`;
            retryWarning.style.display = "block";
            setTimeout(() => {
              invalidCredentials.style.display = "none";
            }, 3000);
          }
          return;
        }
        // Check for invalid password only
        if (password === "wrongpass") {
          invalidPassword.style.display = "block";
          setTimeout(() => {
            invalidPassword.style.display = "none";
          }, 3000);
          return;
        }
        // Check for invalid username only
        if (username === "invalid@example.com") {
          invalidUsername.style.display = "block";
          setTimeout(() => {
            invalidUsername.style.display = "none";
          }, 3000);
          return;
        }
        // Successful login
        showPage('dashboard');
        // Show success message and then fade it out after 2 seconds
        loginSuccess.style.display = "block";
        loginSuccess.classList.remove("fade-out");
        setTimeout(() => {
          loginSuccess.classList.add("fade-out");
        }, 2000);
        // Load products
        loadProducts();
      });
      // Logout functionality
      document.getElementById("logoutBtn").addEventListener("click", function() {
        // Clear cart
        cart = [];
        updateCartCount();
        // Clear recent activity
        recentActivity.innerHTML = `
        
																																	<p>You have no recent activity</p>
																																	<p style="font-size: 14px; color: #777; margin-top: 10px;">Start shopping to see your activity here</p>
      `;
        // Clear checkout form
        clearCheckoutForm();
        showPage('logout-message');
        // Reset success message state
        loginSuccess.style.display = "none";
        loginSuccess.classList.remove("fade-out");
        setTimeout(() => {
          showPage('login-container');
          usernameInput.value = "";
          passwordInput.value = "";
          usernameError.style.display = "none";
        }, 1500);
      });
      // Theme toggle
      function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        // Re-render chart if in analytics section
        if (document.getElementById('analytics-section').style.display === 'block') {
          renderCardUsageChart();
        }
      }
	  
      // Card type selection handler
      //cardTypeSelect.addEventListener('change', function() {
      // Hide all logos first
      //document.querySelectorAll('.card-type-logo').forEach(logo => {
      //logo.style.display = 'none';
      //});
	  
	cardTypeSelect.addEventListener('change', function() {
	  // Hide all logos first
	  document.querySelectorAll('.card-type-logo').forEach(logo => {
		logo.style.display = 'none';
	  });

	  const selected = this.value;
	  if (selected) {
		// Show selected logo
		document.querySelectorAll(`.${selected}-logo`).forEach(logo => {
		  logo.style.display = '';
		});
		// Clear any error state
		document.querySelector('.card-type-container').classList.remove('has-error');
		document.getElementById('card-type-error').style.display = 'none';
	  }
	});

	  
      // Password visibility toggle
      function togglePassword() {
        const password = document.getElementById('password');
        const icon = document.getElementById('toggleIcon');
        const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
        password.setAttribute('type', type);
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
      }
      // Page navigation function
      function showPage(pageId) {
        const pages = ["login-container", "dashboard", "products-page", "checkout-page", "logout-message", "order-processing-page", "order-complete-page", "order-failed-page"];
        pages.forEach(page => {
          document.getElementById(page).style.display = page === pageId ? "block" : "none";
        });
      }
      // Load products
      function loadProducts() {
        productsContainer.innerHTML = "";
        products.forEach(product => {
          const productCard = document.createElement("div");
          productCard.className = "product-card";
          productCard.innerHTML = `
          
																																	<img src="${product.image}" alt="${product.name}" class="product-image">
																																		<div class="product-info">
																																			<div class="product-title">${product.name}</div>
																																			<div class="product-price">$${product.price.toFixed(2)}</div>
																																			<div class="product-actions">
																																				<button onclick="addToCart(${product.id})" class="add-to-cart-btn">
																																					<i class="fas fa-cart-plus" style="margin-right: 5px;"></i> Add to Cart
              
																																				</button>
																																			</div>
																																		</div>
        `;
          productsContainer.appendChild(productCard);
        });
      }
      // Navigation functions
      function showProducts() {
        showPage('products-page');
      }

      function backToDashboard() {
        showPage('dashboard'); // ‚úÖ Show only the dashboard
        document.getElementById('analytics-section').style.display = 'none'; // ‚ùå Hide analytics section explicitly
      }

      function viewCart() {
        if (cart.length === 0) {
          showNotification("Your cart is empty");
          return;
        }
        showPage('checkout-page');
        renderCheckoutItems();
      }

      function backToProducts() {
        showPage('products-page');
        // ‚úÖ Reset payment retry attempts and warning
        paymentFailedAttempts = 0;
        const retryBtn = document.getElementById("retryPaymentBtn");
        const retryWarning = document.getElementById("payment-retry-warning");
        if (retryBtn) {
          retryBtn.disabled = false;
          retryBtn.style.opacity = 1;
		  retryBtn.onclick = retryPayment;
        }
        if (retryWarning) {
          retryWarning.style.display = "none";
          retryWarning.textContent = "";
        }
      }
      // Cart functions
      function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        const existingItem = cart.find(item => item.id === productId);
        if (existingItem) {
          existingItem.quantity += 1;
        } else {
          cart.push({
            ...product,
            quantity: 1
          });
        }
        updateCartCount();
        showNotification(`${product.name} added to cart`);
      }

      function removeFromCart(productId) {
        cart = cart.filter(item => item.id !== productId);
        updateCartCount();
        renderCheckoutItems();
      }

      function updateQuantity(productId, newQuantity) {
        const item = cart.find(item => item.id === productId);
        if (item) {
          newQuantity = parseInt(newQuantity) || 1;
          newQuantity = Math.max(1, newQuantity);
          item.quantity = newQuantity;
          renderCheckoutItems();
        }
      }

      function updateCartCount() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById("cart-count").textContent = totalItems;
        document.getElementById("cart-count-products").textContent = totalItems;
      }

      function showNotification(message) {
        const notification = document.createElement("div");
        notification.style.position = "fixed";
        notification.style.bottom = "20px";
        notification.style.right = "20px";
        notification.style.backgroundColor = "var(--notification-bg)";
        notification.style.color = "var(--notification-text)";
        notification.style.padding = "10px 20px";
        notification.style.borderRadius = "4px";
        notification.style.boxShadow = "0 2px 10px rgba(0,0,0,0.2)";
        notification.style.zIndex = "1000";
        notification.style.fontWeight = "bold";
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.style.opacity = "0";
          notification.style.transition = "opacity 0.5s";
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 500);
        }, 3000);
      }

      function renderCheckoutItems() {
        checkoutItems.innerHTML = "";
        let subtotal = 0;
        cart.forEach(item => {
          const itemTotal = item.price * item.quantity;
          subtotal += itemTotal;
          const cartItem = document.createElement("div");
          cartItem.className = "cart-item";
          cartItem.innerHTML = `
      
																																		<div class="cart-item-info">
																																			<img src="${item.image}" alt="${item.name}" class="cart-item-image">
																																				<div class="cart-item-details">
																																					<div class="cart-item-name" title="${item.name}">${item.name}</div>
																																					<div style="font-size: 14px; color: #777;">${item.quantity} √ó $${item.price.toFixed(2)}</div>
																																				</div>
																																			</div>
																																			<div class="cart-item-quantity">
																																				<button class="quantity-btn" onclick="handleDecrement(${item.id})">-</button>
																																				<input type="number" class="quantity-input" value="${item.quantity}" min="1"
               oninput="handleManualQuantityChange(${item.id}, this)">
																																					<button class="quantity-btn" onclick="handleIncrement(${item.id})">+</button>
																																				</div>
																																				<div class="cart-item-price">
																																					<div class="cart-item-price-value">$${itemTotal.toFixed(2)}</div>
																																					<button class="remove-item" onclick="removeFromCart(${item.id})">
																																						<i class="fas fa-trash"></i>
																																					</button>
																																				</div>
    `;
          checkoutItems.appendChild(cartItem);
        });
        const shipping = cart.length > 0 ? SHIPPING_COST : 0;
        const tax = subtotal * TAX_RATE;
        const total = subtotal + shipping + tax;
        document.getElementById("checkout-subtotal").textContent = subtotal.toFixed(2);
        document.getElementById("checkout-shipping").textContent = shipping.toFixed(2);
        document.getElementById("checkout-tax").textContent = tax.toFixed(2);
        document.getElementById("checkout-total").textContent = total.toFixed(2);
      }
      // New quantity control functions
      function handleIncrement(productId) {
        const item = cart.find(item => item.id === productId);
        if (item) {
          item.quantity++;
          renderCheckoutItems();
        }
      }

      function handleDecrement(productId) {
        const item = cart.find(item => item.id === productId);
        if (item) {
          item.quantity = Math.max(1, item.quantity - 1);
          renderCheckoutItems();
        }
      }

      function handleManualQuantityChange(productId, input) {
        let rawValue = input.value;
        // Remove non-digit characters
        rawValue = rawValue.replace(/[^\d]/g, '');
        let newValue = parseInt(rawValue);
        if (isNaN(newValue) || newValue < 1) {
          newValue = 1;
        }
        input.value = newValue; // Ensure the input field shows only the number
        const item = cart.find(item => item.id === productId);
        if (item) {
          item.quantity = newValue;
          renderCheckoutItems();
        }
      }

      function logPurchase() {
        const total = document.getElementById('checkout-total').textContent;
        const now = new Date();
        const formattedDate = now.toLocaleString();
        recentActivity.innerHTML = `
        
																																				<p>‚úÖ Purchase completed - $${total}</p>
																																				<p style="font-size: 14px; color: #777; margin-top: 10px;">${formattedDate}</p>
      `;
      }

      function clearCheckoutForm() {
        document.getElementById("card-type").value = "";
        document.getElementById("card-name").value = "";
        document.getElementById("card-number").value = "";
        document.getElementById("expiry").value = "";
        document.getElementById("cvv").value = "";
        document.getElementById("full-name").value = "";
        document.getElementById("address").value = "";
        document.getElementById("city").value = "";
        document.getElementById("zip").value = "";
        document.getElementById("country").value = "US";
        document.getElementById("billing-full-name").value = "";
        document.getElementById("billing-address").value = "";
        document.getElementById("billing-city").value = "";
        document.getElementById("billing-zip").value = "";
        document.getElementById("billing-country").value = "US";
        sameBillingCheckbox.checked = true;
        billingAddressSection.style.display = 'none';
        // Hide all card logos
        document.querySelectorAll('.card-type-logo').forEach(logo => {
          logo.style.display = 'none';
        });
        // Hide all error messages
        document.querySelectorAll('.error-message').forEach(error => {
          error.style.display = 'none';
        });
      }
      //console.log("üü¢ completePurchase() triggered");
      function completePurchase() {
        // Hide all previous error messages
        document.querySelectorAll('.error-message').forEach(error => {
          error.style.display = 'none';
        });
        // Validate form
        let isValid = true;
        // Shipping information validation
        if (!document.getElementById("full-name").value) {
          document.getElementById("full-name-error").style.display = "block";
          isValid = false;
        }
        if (!document.getElementById("address").value) {
          document.getElementById("address-error").style.display = "block";
          isValid = false;
        }
        if (!document.getElementById("city").value) {
          document.getElementById("city-error").style.display = "block";
          isValid = false;
        }
        // Shipping postal code validation
        const shippingZip = document.getElementById("zip").value;
        const country = document.getElementById("country").value;
        if (!shippingZip) {
          document.getElementById("zip-error").textContent = "Please enter your postal code";
          document.getElementById("zip-error").style.display = "block";
          isValid = false;
        } else if (!validatePostalCode(shippingZip, country)) {
          document.getElementById("zip-error").textContent = "Invalid Postal Code";
          document.getElementById("zip-error").style.display = "block";
          isValid = false;
        }
        // Validate payment information
        const isPaymentValid = validatePaymentForm();
        isValid = isValid && isPaymentValid;
        // Billing address validation if not same as shipping
        if (!sameBillingCheckbox.checked) {
          if (!document.getElementById("billing-full-name").value) {
            showNotification("Please fill all billing address fields");
            isValid = false;
          }
          if (!document.getElementById("billing-address").value) {
            showNotification("Please fill all billing address fields");
            isValid = false;
          }
          if (!document.getElementById("billing-city").value) {
            showNotification("Please fill all billing address fields");
            isValid = false;
          }
          const billingZip = document.getElementById("billing-zip").value;
          const billingCountry = document.getElementById("billing-country").value;
          if (!billingZip) {
            document.getElementById("billing-zip-error").textContent = "Please enter your postal code";
            document.getElementById("billing-zip-error").style.display = "block";
            isValid = false;
          } else if (!validatePostalCode(billingZip, billingCountry)) {
            document.getElementById("billing-zip-error").textContent = "Invalid Postal Code";
            document.getElementById("billing-zip-error").style.display = "block";
            isValid = false;
          }
        }
        if (!isValid) {
          showNotification("Please fill all required fields correctly");
          return;
        }
        // Track card type usage
        const cardType = document.getElementById("card-type").value;
        if (cardType && cardUsageCounts.hasOwnProperty(cardType)) {
          cardUsageCounts[cardType]++;
        }
        const rawCard = document.getElementById("card-number").value.replace(/\D/g, ''); // strip all non-digits
        console.log("Raw Card Entered:", rawCard);
		const failedCards = [
		  "4000000000009995", // Visa - Insufficient funds
		  "4000000000000002", // Visa - Card not supported
		  "4111111111111119", // Visa - Invalid card
		  "5555555555558726", // MasterCard - Invalid card
		  "376525000000010",  // Amex - Invalid card
		  "6011000000001010"  // Discover - Invalid card
		];

		// In the completePurchase function:
		if (failedCards.includes(rawCard)) {
		  showPage('order-processing-page');
		  setTimeout(() => {
			showPage('order-failed-page');
			const failureReason = cardFailureReasons[rawCard] || "Unknown failure";
			document.getElementById("payment-failure-reason").innerHTML = `<li>${failureReason}</li>`;
			document.getElementById("payment-failure-reason").style.display = "block";
			showNotification("Order Failed!", true);
			
			// Don't increment here - first failure is attempt 1 of 3
			const remainingAttempts = maxPaymentRetries - paymentFailedAttempts - 1;
			const retryWarning = document.getElementById("payment-retry-warning");
			const retryBtn = document.getElementById("retryPaymentBtn");

			if (remainingAttempts > 0) {
			  retryWarning.innerHTML = `‚ö†Ô∏è You have ${remainingAttempts} attempt${remainingAttempts === 1 ? '' : 's'} left before retry is disabled.`;
			  retryBtn.disabled = false;
			  retryBtn.style.opacity = 1;
			} else {
			  retryWarning.innerHTML = `‚ö†Ô∏è Retry limit reached. Please try again later or contact support.`;
			  retryBtn.disabled = true;
			  retryBtn.style.opacity = 0.6;
			  retryBtn.onclick = null;
			}
			retryWarning.style.display = "block";
			
			const now = new Date();
			recentActivity.innerHTML = `
			  <p>‚ùå Payment failed - Card ending in ${rawCard.slice(-4)}</p>
			  <p style="font-size: 14px; color: #777;">${now.toLocaleString()}</p>
			`;
		  }, 1500);
		  return;
		}


        // Show processing page
        showPage('order-processing-page');
        // Simulate processing delay
        setTimeout(() => {
          showPage('order-complete-page');
          logPurchase();
          clearCheckoutForm();
          // Clear cart
          cart = [];
          updateCartCount();
          // Reset payment retry attempts
          paymentFailedAttempts = 0;
        }, 2000);
      }

		// Updated retryPayment function:
		function retryPayment() {
		  // Increment attempt counter when retrying
		  paymentFailedAttempts++;
		  
		  const remainingAttempts = maxPaymentRetries - paymentFailedAttempts - 1;
		  const retryWarning = document.getElementById("payment-retry-warning");
		  const retryBtn = document.getElementById("retryPaymentBtn");

		  if (remainingAttempts > 0) {
			retryWarning.innerHTML = `‚ö†Ô∏è You have ${remainingAttempts} attempt${remainingAttempts === 1 ? '' : 's'} left before retry is disabled.`;
			retryBtn.disabled = false;
			retryBtn.style.opacity = 1;
		  } else {
			retryWarning.innerHTML = `‚ö†Ô∏è Retry limit reached. Please try again later or contact support.`;
			retryBtn.disabled = true;
			retryBtn.style.opacity = 0.6;
			retryBtn.onclick = null;
		  }
		  
		  // Go back to checkout to retry
		  showPage('checkout-page');
		}
		
      const cardUsageCounts = {
        visa: 0,
        mastercard: 0,
        amex: 0,
        discover: 0
      };

      function showAnalytics() {
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('analytics-section').style.display = 'block';
        renderCardUsageChart();
      }
      let cardUsageChartInstance = null;

      function renderCardUsageChart() {
        const ctx = document.getElementById('cardUsageChart').getContext('2d');
        // Destroy the old chart instance if it exists
        if (cardUsageChartInstance) {
          cardUsageChartInstance.destroy();
        }
        const isDarkMode = document.body.classList.contains('dark-mode');
        cardUsageChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(cardUsageCounts),
            datasets: [{
              label: 'Usage Count',
              data: Object.values(cardUsageCounts),
              backgroundColor: ['#1a73e8', '#fbbc05', '#34a853', '#ff6d00']
            }]
          },
          options: {
            plugins: {
              legend: {
                labels: {
                  color: isDarkMode ? '#ffffff' : '#000000' // Legend color
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  color: isDarkMode ? '#ffffff' : '#000000' // X-axis labels
                },
                grid: {
                  color: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' // X grid lines
                }
              },
              y: {
                ticks: {
                  color: isDarkMode ? '#ffffff' : '#000000' // Y-axis labels
                },
                grid: {
                  color: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' // Y grid lines
                }
              }
            }
          }
        });
      }
      // Initialize event listeners for navigation
      document.addEventListener('DOMContentLoaded', function() {
        // Dashboard buttons
        document.querySelector('.btn[onclick="showProducts()"]').addEventListener('click', showProducts);
        //document.querySelector('.btn[onclick="showAnalytics()"]').addEventListener('click', showAnalytics);
        document.getElementById('viewAnalyticsBtn').addEventListener('click', showAnalytics);
        document.getElementById('logoutBtn').addEventListener('click', function() {
          showPage('logout-message');
          setTimeout(() => showPage('login-container'), 1500);
        });
        // Products page buttons
        document.querySelector('button[onclick="backToDashboard()"]').addEventListener('click', backToDashboard);
        document.querySelector('button[onclick="viewCart()"]').addEventListener('click', viewCart);
        // Checkout page buttons
        document.querySelector('button[onclick="backToProducts()"]').addEventListener('click', backToProducts);
        document.querySelector('button[onclick="completePurchase()"]').addEventListener('click', completePurchase);
      });
    </script>
  </body>
</html>